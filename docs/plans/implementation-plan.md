# CODA 実装計画書

## 概要
本文書は、CODA（CODing Agent）の実装を段階的に進めるための作業計画を定義します。各フェーズは前フェーズの成果物に依存し、インクリメンタルに機能を追加していきます。

## 実装フェーズ

### Phase 0: プロジェクト基盤構築（1日）
**目的**: 開発環境とプロジェクト構造の確立

#### タスク一覧
1. **プロジェクト初期化**
   - [x] go mod init github.com/common-creation/coda
   - [x] 基本的なディレクトリ構造の作成
   - [x] .gitignore, README.md の作成

2. **開発環境設定**
   - [x] Makefile の作成（ビルド、テスト、リント）
   - [x] GitHub Actions の設定（CI/CD）
   - [x] pre-commit hooks の設定

3. **依存関係の追加**
   - [x] 必要なライブラリのインストール
   - [x] go.mod の更新

### Phase 1: コア基盤実装（3日）
**目的**: AIクライアントと設定管理の基本実装

#### タスク一覧
1. **設定管理システム** (internal/config/)
   - [x] config.go - 設定構造体の定義
   - [x] loader.go - YAML設定ローダー
   - [x] secrets.go - APIキー管理
   - [ ] 単体テストの作成

2. **AIクライアント抽象化層** (internal/ai/)
   - [x] client.go - 統一インターフェース定義 (2025-07-30完了)
   - [x] types.go - 共通型定義 (2025-07-30完了)
   - [x] errors.go - エラー型定義 (2025-07-30完了)

3. **OpenAIクライアント実装** (internal/ai/)
   - [x] openai.go - OpenAI実装 (2025-07-30完了)
   - [x] openai_test.go - モックを使ったテスト (2025-07-30完了)
   - [x] ストリーミング対応 (2025-07-30完了)

4. **Azure OpenAIクライアント実装** (internal/ai/)
   - [x] azure.go - Azure OpenAI実装 (2025-07-30完了)
   - [x] azure_test.go - モックを使ったテスト (2025-07-30完了)
   - [x] エンドポイント設定対応 (2025-07-30完了)

### Phase 2: ツールシステム実装（2日）
**目的**: ツール管理システムと基本ツールの実装

#### タスク一覧
1. **ツールマネージャー** (internal/tools/)
   - [x] manager.go - ツール管理システム (2025-07-30完了)
   - [x] interface.go - ツールインターフェース定義 (2025-07-30完了)
   - [x] registry.go - ツール登録システム (2025-07-30完了)

2. **基本ツール実装** (internal/tools/)
   - [x] file.go - read_file, write_file, edit_file (2025-07-30完了)
   - [x] list.go - list_files (2025-07-30完了)
   - [x] search.go - search_files (2025-07-30完了)
   - [ ] 各ツールのテスト作成

3. **セキュリティ検証** (internal/security/)
   - [x] validator.go - ファイルアクセス検証 (2025-07-30完了)
   - [x] patterns.go - 危険パターンの定義 (2025-07-30完了)
   - [ ] validator_test.go - セキュリティテスト

### Phase 3: チャットハンドラー実装（3日）
**目的**: チャット処理のコアロジック実装

#### タスク一覧
1. **セッション管理** (internal/chat/)
   - [x] session.go - セッション状態管理 (2025-07-30完了)
   - [x] history.go - 会話履歴管理 (2025-07-30完了)
   - [x] persistence.go - セッション永続化 (2025-07-30完了)

2. **メッセージ処理** (internal/chat/)
   - [x] handler.go - メインチャットハンドラー (2025-07-30完了)
   - [x] stream.go - ストリーミング処理 (2025-07-30完了)
   - [x] prompts.go - システムプロンプト管理 (2025-07-30完了)

3. **ツール連携** (internal/chat/)
   - [x] tools.go - ツールコール検出と実行 (2025-07-30完了)
   - [x] approval.go - ユーザー承認システム (2025-07-30完了)
   - [x] result_processor.go - ツール結果処理 (2025-07-30完了)

4. **ワークスペース対応**
   - [x] workspace.go - CLAUDE.md/CODA.md読み込み (2025-07-30完了)
   - [x] context.go - コンテキスト管理 (2025-07-30完了)

### Phase 4: CLI実装（2日）
**目的**: Cobraを使ったCLIコマンドの実装

#### タスク一覧
1. **基本コマンド** (cmd/)
   - [x] root.go - ルートコマンド (2025-07-30完了)
   - [x] chat.go - チャットコマンド (2025-07-30完了)
   - [x] config.go - 設定コマンド (2025-07-30完了)
   - [x] version.go - バージョン表示 (2025-07-30完了)

2. **コマンドオプション**
   - [x] モデル選択オプション (2025-07-30完了)
   - [x] 設定ファイル指定 (2025-07-30完了)
   - [x] デバッグモード (2025-07-30完了)
   - [x] 非対話モード (2025-07-30完了)

3. **ヘルプとドキュメント**
   - [x] コマンドヘルプの充実 (2025-07-30完了)
   - [x] 使用例の追加 (2025-07-30完了)

### Phase 5: Bubbletea UI実装（4日）
**目的**: リッチなターミナルUIの実装

#### タスク一覧
1. **UIフレームワーク** (internal/ui/)
   - [ ] app.go - メインアプリケーション
   - [ ] model.go - Bubbleteaモデル
   - [ ] update.go - イベントハンドリング
   - [ ] styles.go - スタイル定義

2. **ビューコンポーネント** (internal/ui/views/)
   - [ ] chat_view.go - チャット表示
   - [ ] input_view.go - 入力エリア
   - [ ] status_view.go - ステータスバー
   - [ ] help_view.go - ヘルプ表示

3. **高度なUI機能** (internal/ui/components/)
   - [ ] syntax_highlighter.go - シンタックスハイライト
   - [ ] markdown_renderer.go - Markdown描画
   - [ ] progress_indicator.go - プログレス表示
   - [ ] tool_approval.go - ツール承認UI

4. **キーバインディング**
   - [x] keybindings.go - 高度なキーマップ定義システム (2025-07-30完了)
   - [x] keybindings_config.go - カスタマイズ可能な設定システム (2025-07-30完了)
   - [x] Vim/Emacs/Defaultスタイルサポート (2025-07-30完了)
   - [x] モード別キーハンドリング (Normal/Insert/Command/Search) (2025-07-30完了)
   - [x] キーバインド競合検出と検証システム (2025-07-30完了)
   - [x] コンテキスト別ヘルプ統合 (2025-07-30完了)

5. **ショートカット処理システム**
   - [x] shortcuts.go - ショートカット管理とコマンドパレット (2025-07-30完了)
   - [x] context_actions.go - コンテキストアクション機能 (2025-07-30完了)
   - [x] shortcuts_integration.go - 既存システムとの統合 (2025-07-30完了)
   - [x] コマンドパレット機能（Ctrl+Shift+P） (2025-07-30完了)
   - [x] マクロ記録・再生機能 (2025-07-30完了)
   - [x] ファイルパス・URL・コードブロックのコンテキストアクション (2025-07-30完了)

### Phase 6: 統合とテスト（3日）
**目的**: 全コンポーネントの統合とテスト

#### タスク一覧
1. **統合テスト**
   - [x] E2Eテストの作成 (2025-07-30完了 - task-062)
   - [x] シナリオベーステスト (2025-07-30完了 - task-062)
   - [x] パフォーマンステスト (2025-07-30完了 - task-062)

2. **エラーハンドリング**
   - [x] グローバルエラーハンドラー (2025-07-30完了 - task-065)
   - [x] リカバリー機構 (2025-07-30完了 - task-066)
   - [x] ユーザーフレンドリーなエラー表示 (2025-07-30完了 - task-065統合)

3. **ロギングとデバッグ**
   - [x] 構造化ログの実装 (2025-07-31完了)
   - [x] デバッグモードの充実 (2025-07-31完了)
   - [x] トレーシング機能 (2025-07-31完了)

### Phase 7: ドキュメントとリリース（2日）
**目的**: ドキュメント整備とリリース準備

#### タスク一覧
1. **ユーザードキュメント**
   - [x] README.md の完成 (2025-07-30完了)
   - [x] インストールガイド (2025-07-31完了)
   - [x] 使用方法ドキュメント (2025-07-31完了)
   - [x] トラブルシューティング (2025-07-31完了)

2. **開発者ドキュメント**
   - [x] アーキテクチャドキュメント (2025-07-31完了)
   - [ ] API仕様書
   - [ ] プラグイン開発ガイド

3. **リリース準備**
   - [x] バイナリビルドスクリプト (2025-07-30完了)
   - [x] リリースノート作成 (2025-07-31完了)
   - [ ] インストーラー作成

## リスクと対策

### 技術的リスク
1. **OpenAI APIの変更**
   - 対策: 抽象化層により影響を最小化
   - バージョン固定と段階的アップデート

2. **Bubbleteaの複雑性**
   - 対策: シンプルなコンポーネントから開始
   - 公式サンプルの活用

3. **ストリーミング処理の複雑性**
   - 対策: 十分なエラーハンドリング
   - タイムアウト処理の実装

### スケジュールリスク
1. **予期しない技術的課題**
   - 対策: 各フェーズに20%のバッファを確保
   - 早期のプロトタイプ作成

2. **テストの遅延**
   - 対策: TDD的アプローチの採用
   - 継続的なテスト実行

## 成功指標

### 機能面
- [ ] OpenAIとAzure OpenAIの両方で動作
- [ ] 全ての基本ツールが正常動作
- [ ] ストリーミング応答がスムーズ
- [ ] エラー時の適切なリカバリー

### 品質面
- [ ] テストカバレッジ 80%以上
- [ ] 応答時間 100ms以下（UI操作）
- [ ] メモリ使用量 100MB以下
- [ ] ゼロクラッシュ

### ユーザビリティ
- [ ] 直感的なUI操作
- [ ] 分かりやすいエラーメッセージ
- [ ] 充実したヘルプ機能
- [ ] スムーズなインストール体験

## 実装順序の根拠

1. **Phase 0-1**: 基盤なしには何も始まらない
2. **Phase 2**: ツールはチャットの前提条件
3. **Phase 3**: コアロジックの実装
4. **Phase 4**: CLIで基本動作確認
5. **Phase 5**: UIは機能完成後に追加
6. **Phase 6-7**: 品質保証とリリース

## 総工数見積もり
- 開発: 20日
- テスト・デバッグ: 5日
- ドキュメント: 3日
- **合計: 約28日（1.5ヶ月）**

※ 1人での開発を想定。チーム開発の場合は並列化により短縮可能。